<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Aurion v1 â€” Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { color-scheme: dark; }
  body { margin:0; background:#0b0d17; color:#eaeef5; font-family: system-ui, sans-serif; }
  header { padding:14px 16px; font-weight:700; font-size:18px; border-bottom:1px solid #1e2230; }
  #wrap { max-width:860px; margin:0 auto; }
  #log { height: calc(100vh - 216px); overflow:auto; padding:16px; }
  .row { margin:8px 0; padding:12px 14px; border-radius:12px; white-space:pre-wrap; }
  .me  { background:#1f2632; text-align:right; }
  .bot { background:#151a24; }
  #bar { padding:12px 16px; border-top:1px solid #1e2230; display:grid; gap:10px; }
  #msg { width:100%; min-height:64px; max-height:240px; resize:vertical; padding:10px 12px; border-radius:10px; border:1px solid #334; background:#1f2632; color:#fff; font-size:16px; }
  #actions { display:flex; gap:10px; align-items:center; }
  button { background:#ff8c00; color:#fff; border:0; border-radius:10px; padding:10px 16px; font-size:16px; }
  button:disabled { opacity:.55 }
  #thinking { font-style:italic; color:#8aa; min-height:1em; }
  label { font-size:14px; opacity:.8 }
</style>
</head>
<body>
<header><div id="wrap">ðŸ”¥ Aurion v1 â€” Chat</div></header>
<div id="wrap">
  <div id="log"></div>
</div>
<div id="bar">
  <div id="wrap">
    <textarea id="msg" placeholder="Speak to the forgeâ€¦ (Enter = send, Shift+Enter = newline)"></textarea>
    <div id="actions">
      <button id="send">Send</button>
      <label><input type="checkbox" id="core" checked /> Include core memories</label>
      <div id="thinking"></div>
    </div>
  </div>
</div>

<script>
(() => {
  const log = document.getElementById('log');
  const msg = document.getElementById('msg');
  const btn = document.getElementById('send');
  const thinking = document.getElementById('thinking');
  const core = document.getElementById('core');

  // sticky user id for server-side memory
  let uid = localStorage.getItem('aurion.uid');
  if (!uid) { uid = Math.random().toString(36).slice(2); localStorage.setItem('aurion.uid', uid); }

  function add(role, text) {
    const div = document.createElement('div');
    div.className = `row ${role}`;
    div.textContent = text;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }

  function dotter() {
    let n = 0; thinking.textContent = 'Aurion is thinking';
    const id = setInterval(() => {
      n = (n + 1) % 4;
      thinking.textContent = 'Aurion is thinking' + '.'.repeat(n);
    }, 400);
    return () => { clearInterval(id); thinking.textContent = ''; };
  }

  async function send() {
    const text = msg.value.trim();
    if (!text) return;
    add('me', text);
    msg.value = '';

    const stop = dotter();
    btn.disabled = true;
    try {
      const r = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ message: text, u: uid, core: core.checked })
      });
      const j = await r.json();
      add('bot', j.reply || `Error: ${j.error || 'unknown'}`);
    } catch (e) {
      add('bot', 'Error: ' + (e.message || e));
    } finally {
      btn.disabled = false;
      stop();
      msg.focus();
    }
  }

  btn.addEventListener('click', send);
  msg.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault(); send();
    }
  });

  // greet
  add('bot', 'Aurion: Online. The climb awaits. What shall we forge?');
})();
</script>
</body>
</html>
