<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ðŸ”¥ Aurion v1 â€” Chat</title>
  <style>
    :root{--bg:#0b0f14;--panel:#121824;--bubble:#0f2a5a;--you:#123a8f;--text:#dfe7ff;--muted:#9fb0d1;--accent:#4aa7ff;--green:#31c48d;--warn:#ffcc66}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    header{display:flex;align-items:center;gap:.75rem;padding:14px 16px;border-bottom:1px solid #1e2636;background:var(--panel);position:sticky;top:0;z-index:5}
    header h1{margin:0;font-size:20px}
    header .right{margin-left:auto;display:flex;gap:.5rem}
    header .btn{padding:8px 12px;border-radius:10px;background:#1a2231;border:1px solid #2b3a56;color:var(--text);cursor:pointer}
    header .btn:hover{border-color:#3e5a8a}
    main{max-width:820px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:14px}
    .msg{max-width:85%;padding:14px 16px;border-radius:16px;background:#0f2a5a;box-shadow:0 1px 0 #0b1733}
    .aurion{background:#0f213f}
    .you{background:var(--you);align-self:flex-end}
    .from{color:var(--muted);font-size:12px;margin-bottom:6px}
    .typing{font-size:14px;color:var(--muted)}
    .dots{display:inline-flex;gap:4px;margin-left:6px;vertical-align:middle}
    .dot{width:6px;height:6px;border-radius:50%;background:#627399;opacity:.3;animation:b 1.3s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes b{0%,80%,100%{opacity:.2;transform:translateY(0)}40%{opacity:1;transform:translateY(-3px)}}
    .composer{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(11,15,20,0),rgba(11,15,20,.9) 18%,var(--bg) 36%);padding:16px}
    .row{display:flex;gap:10px}
    textarea{flex:1;min-height:46px;max-height:220px;resize:vertical;border-radius:12px;border:1px solid #2b3a56;background:#0e1522;color:var(--text);padding:12px}
    .send{background:var(--accent);border:none;color:#001b33;padding:12px 18px;font-weight:700;border-radius:12px;cursor:pointer}
    .hint{color:#7d8fb3;font-size:12px;margin-top:8px;text-align:center}
    a{color:var(--accent);text-decoration:none}
    /* modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:30}
    .sheet{width:min(680px,100%);background:var(--panel);border:1px solid #2b3a56;border-radius:14px;padding:16px}
    .sheet h3{margin:0 0 10px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    .input, .select{width:100%;padding:10px;border-radius:10px;border:1px solid #2b3a56;background:#0e1522;color:var(--text)}
    .rowr{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .ghost{background:#1a2231;border:1px solid #2b3a56;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
    .primary{background:var(--green);border:none;color:#012018;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
  </style>
</head>
<body>
  <header>
    <h1>ðŸ”¥ Aurion v1 â€” <span style="color:#9fb0d1">Chat</span></h1>
    <div class="right">
      <button class="btn" id="btnPropose">Propose change</button>
      <a class="btn" href="/dev.html">Dev console</a>
      <a class="btn" href="/core.html">Core memory</a>
    </div>
  </header>

  <main id="log">
    <div class="msg aurion">
      <div class="from">Aurion</div>
      Aurion online. The climb awaits. What shall we forge?
    </div>
  </main>

  <div class="composer">
    <div class="row">
      <input id="user" class="input" style="max-width:160px" placeholder="User" value="steve" />
      <textarea id="box" placeholder="Speak to the forgeâ€¦"></textarea>
      <button id="send" class="send">Send</button>
    </div>
    <div class="hint">Press Enter to send â€¢ Every message is autosaved</div>
  </div>

  <!-- Propose modal -->
  <div class="modal" id="modal">
    <div class="sheet">
      <h3>Propose a self-change</h3>
      <div class="grid">
        <label>Target file
          <select id="p_file" class="select">
            <option>server.js</option>
            <option>public/index.html</option>
            <option>public/dev.html</option>
            <option>core.json</option>
          </select>
        </label>
        <label>Reason (what & why)
          <input id="p_reason" class="input" placeholder='e.g., Remove duplicate â€œAurion:â€ label' />
        </label>
        <label>Instruction (how)
          <textarea id="p_instr" class="input" rows="5" placeholder="Describe the change to apply precisely."></textarea>
        </label>
      </div>
      <div class="rowr">
        <button class="ghost" id="p_cancel">Cancel</button>
        <button class="primary" id="p_send">Create proposal</button>
      </div>
    </div>
  </div>

  <script>
    const log = document.getElementById('log');
    const box = document.getElementById('box');
    const send = document.getElementById('send');
    const user = document.getElementById('user');

    const modal = document.getElementById('modal');
    const btnPropose = document.getElementById('btnPropose');
    const p_file = document.getElementById('p_file');
    const p_reason = document.getElementById('p_reason');
    const p_instr = document.getElementById('p_instr');
    const p_cancel = document.getElementById('p_cancel');
    const p_send = document.getElementById('p_send');

    btnPropose.onclick = () => { modal.style.display='flex'; p_reason.focus(); };
    p_cancel.onclick = () => { modal.style.display='none'; };
    window.addEventListener('keydown', e => { if(e.key==='Escape') modal.style.display='none'; });

    p_send.onclick = () => {
      const file = p_file.value.trim();
      const reason = p_reason.value.trim();
      const instr = p_instr.value.trim();
      if(!file || !instr){ alert('File and instruction are required'); return; }
      modal.style.display='none';
      // Compose the chat command
      const cmd = `!propose ${file} | ${reason || 'Update requested'} | ${instr}`;
      sendMessage(cmd);
    };

    const add = (html, cls='aurion') => {
      const d = document.createElement('div');
      d.className = `msg ${cls}`;
      d.innerHTML = html;
      log.appendChild(d);
      log.scrollTop = log.scrollHeight;
    };

    const addYou = (text) => add(`<div class="from">You</div>${escapeHtml(text)}`,'you');
    const addAurion = (text) => add(`<div class="from">Aurion</div>${escapeHtml(text)}`,'aurion');

    function escapeHtml(s){ return s.replace(/[&<>]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[c])); }

    function showTyping(){
      const d = document.createElement('div');
      d.className = 'msg aurion typing';
      d.innerHTML = `<div class="from">Aurion</div>thinking<span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;
      log.appendChild(d);
      log.scrollTop = log.scrollHeight;
      return () => d.remove();
    }

    async function sendMessage(text){
      if(!text.trim()) return;
      addYou(text);
      const hide = showTyping();
      try{
        const r = await fetch('/chat', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ message: text, user: user.value })
        });
        const j = await r.json();
        hide();
        if(!j.success) addAurion(`(signal lost â€” ${j.error || 'try again'})`);
        else addAurion(j.reply.replace(/^Aurion:\s*/i,'')); // UI labels name; donâ€™t duplicate
      }catch(e){
        hide();
        addAurion('(signal lost â€” try again)');
      }
    }

    send.onclick = () => sendMessage(box.value), box.value='';
    box.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){
        e.preventDefault();
        const v = box.value; box.value='';
        sendMessage(v);
      }
    });
  </script>
</body>
</html>
